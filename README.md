# my_accelerator

æœ¬ç§‘æ¯•è®¾çš„é¡¹ç›®

**åŸºäº BWT çš„çŸ­åºåˆ—æ¯”å¯¹ç®—æ³•çš„ç¡¬ä»¶åŠ é€Ÿå™¨**

- *å‚è€ƒæ–‡çŒ®*ï¼š[Hardware-Acceleration of Short-Read Alignment Based on the Burrows-Wheeler Transform](./reference/Hardware-Acceleration%20of%20Short-Read%20Alignment.pdf)

- *æ ¸å¿ƒç®—æ³•*ï¼šå‚è€ƒæ–‡çŒ®ä¸­æåŠ `Algorithm 1. Short-read Alignment Algorithm` 

- *åŠ é€Ÿæ ¸å¿ƒ*ï¼š`Algorithm 1. Short-read Alignment Algorithm` ä¸­çš„ `InexRecur()` 

å€¼å¾—ä¸€æçš„æ˜¯ï¼š

- `InexRecur()` å‡½æ•°çš„é€’å½’è°ƒç”¨å®Œæˆäº†æ•´ä¸ªæ¯”å¯¹è¿‡ç¨‹ã€‚
  
- è¯¥è¿‡ç¨‹çš„è¾“å‡ºç»“æœæ˜¯åç¼€æ•°ç»„/åºåˆ—çš„ç´¢å¼•ï¼ˆSA_indexï¼‰ï¼Œä»éœ€è¦éœ€è¦å€ŸåŠ©å…¶ä»–å·¥å…·ç”Ÿæˆ CIGAR ä¸²ç­‰å…¶ä»–çš„æ¯”å¯¹ä¿¡æ¯ã€‚

- æ ¹æ®è°ƒç”¨ `InexRecur()` å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å‚æ•°å¯ç¡®å®šæœ€ç»ˆçš„ç»“æœï¼Œå› `i<0`å¯¼è‡´çš„é€’å½’ä¸­æ­¢å¯¹åº”çš„`k`å’Œ`l`ä¸ºåŒ¹é…ç»“æœã€‚å› æ­¤ï¼Œè®°å½•è¯¥å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å‚æ•°æ˜¯å¿…è¦çš„ã€‚

---

## å‰æè¯´æ˜

**å®Œæ•´çš„åŠ é€Ÿå™¨ç³»ç»ŸåŒ…å«äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼šæ•°ä¸ªåŠ é€Ÿå™¨æ ¸å¿ƒå’Œæ•°æ®é€šè·¯**

- åŠ é€Ÿå™¨æ ¸å¿ƒçš„æ•´ä½“ç»“æ„ä¸º**çŠ¶æ€æœº**ï¼Œæ¯ä¸ªçŠ¶æ€çš„è®¾è®¡å‚è€ƒäº†**CPUçš„ç»å…¸äº”çº§æµæ°´çº¿**

- æ•°æ®é€šè·¯çš„æ•´ä½“ç»“æ„ä¸º**ä»²è£å™¨+FIFO**ï¼ŒFIFO å’Œå­˜å‚¨å™¨ä¹‹é—´è¿˜æœ‰ä¸€ä¸ªä¸­é—´æ¨¡å—ï¼Œå®ç°æœ€ç»ˆçš„è¯»å–(*å¯ä»¥æ ¹æ®å®é™…éœ€è¦ä¿®æ”¹è¯¥ä¸­é—´æ¨¡å—ä»¥é€‚é…ä¸åŒçš„å­˜å‚¨å™¨*)

è®¾è®¡è¯­è¨€ï¼šverilog HDLï¼ˆ2005å¹´æ ‡å‡†ï¼‰

ç›¸å…³å·¥å…·ï¼švivado 2020.1

æ¿è½½éªŒè¯ï¼špynq-z2ï¼ˆé•œåƒv2.6ï¼‰

---

## æƒ³æ³•æ„æ€

`InexRecur()` æœ¬è´¨ä¸Šæ˜¯é€’å½’è°ƒç”¨ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨ç°åœºå¹¶ä¿å­˜å½“å‰çš„ç»“æœã€‚
  
  æ¯”å¯¹è¿‡ç¨‹éœ€è¦çš„æ•°æ®ï¼š
  
  - 1. ä¸å‚è€ƒåºåˆ—ç›¸å…³ï¼šCï¼ŒOccï¼ˆå‡ºç°æ•°ç»„ï¼‰
  
  - 2. ä¸çŸ­åºåˆ—ç›¸å…³ï¼šWï¼ˆçŸ­åºåˆ—æœ¬èº«ï¼‰ï¼ŒDï¼ˆæœç´¢è¾¹ç•Œï¼‰

  - 3. ä¸æ‰§è¡Œè¿‡ç¨‹æœ‰å…³ï¼šè°ƒç”¨ `InexRecur()` çš„å‚æ•°ï¼Œå½“å‰å‚æ•°æ‰§è¡Œçš„çŠ¶æ€

  å…¶ä¸­ï¼Œå°†1ã€2ä¸¤é¡¹ç§°ä¸º **rom** ï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­åªè¯»ä¸å†™ï¼‰ï¼›3ç§°ä¸º **regfile**ï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰åˆè¯»åˆå†™ï¼‰ã€‚


  ä»æ•°æ®é‡çš„è§’åº¦æ¥è¯´ï¼Œ*C ã€W ã€Déƒ½æ˜¯è¾ƒå°çš„æ•°æ®é‡*ï¼Œä¸éœ€è¦å¤§è§„æ¨¡å­˜å‚¨ï¼Œåˆ©ç”¨ FPGA çš„ç‰‡ä¸Šèµ„æºå°±å¯ä»¥å®ç°å­˜å‚¨ã€‚*Occ æ˜¯å·¨å¤§çš„æ•°æ®é‡ï¼ˆä¸å‚è€ƒåºåˆ—æœ‰å¾ˆå¤§çš„å…³è”ï¼‰*ï¼Œå­˜å‚¨åœ¨ FPGA ä¸Šæ˜¯ä¸ç°å®çš„ï¼Œéœ€è¦ä½¿ç”¨æ¿è½½ DDR å­˜å‚¨å™¨ã€‚

  åŠ é€Ÿå™¨æ ¸å¿ƒçš„ä»»åŠ¡åœ¨äºå–æ•°æ®ã€åˆ¤æ–­å½“å‰æ‰§è¡Œä½ç½®ã€å‘èµ·æ–°çš„è°ƒç”¨ã€æ‰§è¡Œæ¯”å¯¹ç®—æ³•ã€‚

  æ•°æ®é€šè·¯çš„ä»»åŠ¡åœ¨äºå¤„ç†å¤šä¸ªåŠ é€Ÿå™¨æ ¸å¿ƒåŒæ—¶è®¿é—® Occ æ•°æ®æ—¶å‡ºç°çš„å†²çªã€‚

  ğŸ–æ³¨: æ•°æ® C ã€W ã€D é€šè¿‡ç‰‡ä¸Šèµ„æºå®ç°å­˜å‚¨ï¼Œå³æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„æ•°æ®ï¼Œæ˜¯ç§æœ‰æ•°æ®ï¼›è€Œæ•°æ® Occ å­˜å‚¨åœ¨ DDRï¼Œæ˜¯å…±æœ‰æ•°æ®ã€‚

  ğŸ–æ³¨ï¼šè¯»å– Occ çš„è¿‡ç¨‹ä¸­å¿…æ¶‰åŠç­‰å¾…ï¼Œæ•…è¯»å– Occ æ•°æ®é‡‡ç”¨åº”ç­”æœºåˆ¶ã€‚

### åŠ é€Ÿå™¨æ ¸å¿ƒ

  #### çŠ¶æ€æœº
  
  ```mermaid
    stateDiagram
        [*] --> idle 
        idle --> get_param : is_start == true
        get_param --> get_data_1 : is_find == true
        get_data_1 --> ex : is_get_data_in_Occ == false
        get_data_1 --> get_data_2 : is_get_data_in_Occ == true
        get_data_2 --> get_data_3
        get_data_3 --> ex
        ex --> write_back
        write_back --> get_param
        ex --> finish : is_finish == true
        finish --> [*]

        state get_param {
          now --> go_back
          go_back --> now
        }

        note right of idle
            å¤ä½åˆå§‹çŠ¶æ€
        end note

        note right of get_param
            åŒ…å«ä¸€ä¸ªå°çš„çŠ¶æ€æœºï¼Œæ‰¾åˆ°å°šæœªå®Œæˆçš„å‚æ•°è°ƒç”¨
        end note

        note right of get_data_2
            ä¿æŒè¯¥çŠ¶æ€ç›´è‡³æ•°æ®æœ‰æ•ˆ
        end note

        note right of get_data_3
            ä¿æŒè¯¥çŠ¶æ€ç›´è‡³æ•°æ®æœ‰æ•ˆ
        end note
  ```

  #### ç°åœºä¿æŠ¤

  `regfile_state` å’Œ `regfile_InexRecur` ä¸­çš„æ•°æ®ä¸€ä¸€å¯¹åº”ï¼ˆåœ°å€ç›¸åŒï¼‰

  `regfile_InexRecur`: è®°å½•æ¯æ¬¡è°ƒç”¨ `InexRecur()` çš„å‚æ•°

  `regfile_state`ï¼šè®°å½•å¯¹åº”å‚æ•°çš„æ‰§è¡Œä½ç½®ã€å›æº¯åœ°å€ã€å½“å‰æ˜¯å¦æ‰§è¡Œç»“æŸ

  å„ä¸ªæ‰§è¡Œä½ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

  ```
  InexRecur(W, i, z, k, l)
  begin              =================> NONE
  |  if z<D (i) then
  |  |  return Ï†
  |  end             =================> STOP_1
  |  if i < 0 then
  |  |  return [k,l]
  |  end             =================> STOP_2
  |  I = Ï†          
  |  I = I âˆª InexRecur(W, i âˆ’ 1, z âˆ’ 1, k,l)
  |                  =================> INSERTION_{A,C,G,T}
  |  for each b âˆˆ {A, C, G, T} do
  |  |  kb = C (b) + O (b, k âˆ’ 1) + 1
  |  |  lb = C (b) + O (b, l)
  |  |  if kb â‰¤ lb then
  |  |  |  I = I âˆª InexRecur(W, i, z âˆ’ 1, kb, lb)
  |  |  |           =================> DELETION_{A,C,G,T}
  |  |  |  if b = W[i] then
  |  |  |  |  I = I âˆª InexRecur(W, i âˆ’ 1, z, kb, lb)
  |  |  |  |        =================> MATCH_{A,C,G,T}
  |  |  |  else
  |  |  |  |  I = I âˆª  InexRecur(W, i âˆ’ 1, z âˆ’ 1, kb, lb)
  |  |  |  |        =================> SNP_{A,C,G,T}
  |  |  |  end
  |  |  end
  |  end
  |  return I
  end
  ```
  
### æ•°æ®é€šè·¯

æ•°æ®é€šè·¯å¯å¤§è‡´åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- FIFOå‰ï¼šä»²è£å™¨ã€è¯»å–æ§åˆ¶æ¨¡å—`storage_control`(*æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒå¯¹åº”ä¸€ä¸ªè¯»å–æ§åˆ¶æ¨¡å—*)
- FIFOåï¼šFIFOå’Œå­˜å‚¨å™¨ä¹‹é—´çš„ä¸­é—´æ¨¡å—`fifo_between_rom`(*å¯ä»¥æ ¹æ®å®é™…éœ€è¦ä¿®æ”¹è¯¥ä¸­é—´æ¨¡å—ä»¥é€‚é…ä¸åŒçš„å­˜å‚¨å™¨*)
  
#### ä»²è£å™¨

å››é€šé“è½®è¯¢ä»²è£å™¨

æ ¹æ®å½“å‰çš„è¯·æ±‚`req`ï¼Œç»™äºˆä¸åŒçš„`storage_control`ä»¤ç‰Œï¼Œä½¿å¾—`storage_control`è·å–å½“å‰å¯¹FIFOçš„å†™æƒé™ï¼Œå°†æ‰€éœ€è¦çš„æ•°æ®çš„åœ°å€ä»¥åŠ`storage_control`çš„å”¯ä¸€ç¼–å·å†™å…¥åˆ°FIFOã€‚

#### å­˜å‚¨æ§åˆ¶æ¨¡å—

çŠ¶æ€æœº

```mermaid
    stateDiagram
        [*] --> idle 
        idle --> req : storage_ce == true
        req --> write_fifo : grant == current_grant
        write_fifo --> wait_data
        wait_data --> done : è¿”å›çš„æ•°æ®æ˜¯è¯¥æ§åˆ¶æ¨¡å—éœ€è¦çš„
        done --> idle

        note right of idle
            ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœå¤„ç†æ ¸å¿ƒå‘å‡ºè¯»è¯·æ±‚ï¼Œåˆ™è¿›å…¥åˆ° REQ çŠ¶æ€ï¼Œå¹¶ç­‰å¾…ä»²è£å™¨å‘æ”¾ä»¤ç‰Œ
        end note

        note right of req
            å¦‚æœå½“å‰ä»¤ç‰Œæœ‰æ•ˆï¼Œåˆ™è¿›å…¥åˆ° WRITE_FIFO çŠ¶æ€ï¼Œå¹¶å‘ FIFO ä¸­å†™å…¥å¿…è¦çš„æ•°æ®
        end note

        note right of wait_data
            å¦‚æœæ•°æ®æœ‰æ•ˆï¼Œåˆ™è¿”å›å¤„ç†å™¨æ ¸å¿ƒéœ€è¦çš„æ•°æ®å¹¶ç»™äºˆå¿…è¦çš„åº”ç­”ä¿¡å·
        end note
```

#### FIFO

vivadoä¸­è‡ªå¸¦çš„FIFO_ip

#### ä¸­é—´æ¨¡å—

è¯»å– FIFO ä¸­çš„æ•°æ®å¹¶æ ¹æ®åœ°å€ä»å­˜å‚¨ä¸­è¯»å–æœ‰æ•ˆæ•°æ®è¿”å›ç»™å­˜å‚¨æ§åˆ¶æ¨¡å—

çŠ¶æ€æœº

```mermaid
    stateDiagram
        [*] --> idle 
        idle --> get_data : is_empty == false
        get_data --> done : data_valid == true
        done --> refresh
        refresh --> wait
        wait --> get_data : is_empty == false

    note right of refresh
        åˆ·æ–° FIFO çš„è¾“å‡ºæ•°æ®
    end note

```

---
  
## æ–‡ä»¶ç»“æ„

`./sim_1` ä¸­ä¸ºæµ‹è¯•æ–‡ä»¶ï¼›`./sources_1` ä¸­ä¸ºæºä»£ç ã€‚

ğŸ–æ³¨ï¼š`./sim_1` ä¸­å¾ˆå¤šæµ‹è¯•æ–‡ä»¶æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­å†™çš„ï¼Œå…¶è°ƒç”¨çš„æ¨¡å—åç§°ã€æ¥å£å®šä¹‰ä¸æœ€ç»ˆæœ‰å·®å¼‚ã€‚

`./sim_1` ä¸­çš„æµ‹è¯•æ–‡ä»¶å½¼æ­¤æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œä¸å†å…¶ä»‹ç»æ–‡ä»¶ç»“æ„ã€‚

`./sources_1` ä¸­çš„æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ _data                       // ç›¸å…³æ•°æ®
|   |                            
|   â”œâ”€â”€ _public
|   |   |
|   |   â””â”€â”€ Occ.data          
|   |
|   â””â”€â”€ _private
|       | 
|       â”œâ”€â”€ C.data
|       â”œâ”€â”€ read_and_D_1.data
|       â”œâ”€â”€ read_and_D_2.data
|       â”œâ”€â”€ read_and_D_3.data
|       â””â”€â”€ read_and_D_4.data
|
â”œâ”€â”€ _accelerator                // åŠ é€Ÿå™¨æ ¸å¿ƒé¡¶å±‚
|   |                           
|   â”œâ”€â”€ accelerator_top.v       
|   â”œâ”€â”€ accelerator_top_1.v     // æ¯ä¸ªåŠ é€Ÿå™¨å¤„ç†ä¸åŒçš„çŸ­åºåˆ—ï¼Œä½¿ç”¨ä¸åŒ rom_read_and_D
|   â”œâ”€â”€ accelerator_top_2.v
|   â”œâ”€â”€ accelerator_top_3.v
|   â””â”€â”€ accelerator_top_4.v
|
â”œâ”€â”€ _rom_read_and_D             // çŸ­åºåˆ—å­˜å‚¨rom
|   |                            
|   â”œâ”€â”€ rom_read_and_D_1.v
|   â”œâ”€â”€ rom_read_and_D_2.v
|   â”œâ”€â”€ rom_read_and_D_3.v
|   â””â”€â”€ rom_read_and_D_4.v   
|
â”œâ”€â”€ _accelerator_fsm            // åŠ é€Ÿå™¨æ ¸å¿ƒçŠ¶æ€æœº
|   |  
|   â”œâ”€â”€ accelerator_fsm.v       // åŠ é€Ÿå™¨æ ¸å¿ƒçŠ¶æ€æœºé¡¶å±‚
|   â”œâ”€â”€ state_control.v   
|   |      
|   â”œâ”€â”€ _component              // åŠ é€Ÿå™¨çŠ¶æ€æ¨¡å—
|   |   |
|   |   â”œâ”€â”€ get_param.v         // å–å‚æ•°
|   |   â”œâ”€â”€ get_data_1.v        // å–æ•°æ®(rom_read_and_Dã€rom_C)
|   |   â”œâ”€â”€ get_data_2.v        // å–æ•°æ®(rom_Occ)
|   |   â”œâ”€â”€ get_data_3.v        // å–æ•°æ®(rom_Occ)
|   |   â”œâ”€â”€ exa.v               // åˆ¤æ–­/æ‰§è¡Œ
|   |   â””â”€â”€ write_back.v        // å›å†™
|   |
|   â””â”€â”€ _regfile                // å¯„å­˜å™¨
|       |
|       â”œâ”€â”€ regfile_InexRecur.v
|       â”œâ”€â”€ regfile_state.v
|       â””â”€â”€ regfile.v
|
â”œâ”€â”€ _data_path                   // æ•°æ®é€šè·¯
|   |
|   â”œâ”€â”€ data_path.v
|   |
|   â””â”€â”€ _component
|       |
|       â”œâ”€â”€ storage_control.v
|       â”œâ”€â”€ fifo_between_rom.v
|       â”œâ”€â”€ fifo_between_rom.v
|       â”œâ”€â”€ arbiter_4_wrapper.v
|       |
|       â””â”€â”€ _arbiter
|           |
|           â””â”€â”€ round_robin_arbiter_4.v
|
â”œâ”€â”€ rom_Occ.v
â”œâ”€â”€ rom_C.v  
â”œâ”€â”€ rom_read_and_D.v
|
â”œâ”€â”€ top.v                       // å•ä¸ªå¤„ç†å™¨æ ¸å¿ƒè®¾è®¡çš„é¡¶å±‚
â””â”€â”€ top_with_data_path.v        // 4ä¸ªå¤„ç†å™¨æ ¸å¿ƒã€å¸¦æœ‰æ•°æ®é€šè·¯è®¾è®¡çš„é¡¶å±‚
```
---
## é¡¹ç›®ç»“æ„

å¸¦æœ‰æ•°æ®é€šè·¯ã€å››æ ¸åŠ é€Ÿå™¨ç»“æ„

![top_with_data_path](./reference/img/top_with_data_path.png "top_with_data_path")

å•æ ¸åŠ é€Ÿå™¨ç»“æ„

![top](./reference/img/top.png "top")

---

## å¤‡æ³¨ï¼ˆ2020/6/20ï¼‰

ğŸ–æ³¨ï¼šrom ä¸­çš„æ•°æ®åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«åŠ è½½è¿›å»ã€‚ç†æƒ³æƒ…å†µä¸­ rom_Occ ä¼šè¢« ddr ä»£æ›¿


æœ‰å…³ python å’Œ C/C++ è¯­è¨€æ‰§è¡Œæ•ˆç‡çš„å·®åˆ«ï¼Œå‚è€ƒ `./reference` ä¸­çš„æ€»ç»“ã€‚

PL éƒ¨åˆ†ä½¿ç”¨ DDR è¯»å–æ•°æ®ï¼ˆä»¿çœŸæˆåŠŸï¼Œæ¿è½½éªŒè¯å¤±è´¥ï¼‰

å¤šæ ¸å¿ƒå¤„ç†ï¼ˆå››æ ¸å¿ƒå¹¶è¡Œå¤„ç†ï¼‰
