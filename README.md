# my_accelerator

æœ¬ç§‘æ¯•è®¾çš„é¡¹ç›®

**åŸºäº BWT çš„çŸ­åºåˆ—æ¯”å¯¹ç®—æ³•çš„ç¡¬ä»¶åŠ é€Ÿå™¨**

- *å‚è€ƒæ–‡çŒ®*ï¼š[Hardware-Acceleration of Short-Read Alignment Based on the Burrows-Wheeler Transform](./reference/Hardware-Acceleration%20of%20Short-Read%20Alignment.pdf)

- *æ ¸å¿ƒç®—æ³•*ï¼šå‚è€ƒæ–‡çŒ®ä¸­æåŠ `Algorithm 1. Short-read Alignment Algorithm` 

- *åŠ é€Ÿæ ¸å¿ƒ*ï¼š`Algorithm 1. Short-read Alignment Algorithm` ä¸­çš„ `InexRecur()` å‡½æ•°

å€¼å¾—ä¸€æçš„æ˜¯ï¼š

- `InexRecur()` å‡½æ•°çš„é€’å½’è°ƒç”¨å®Œæˆäº†æ•´ä¸ªæ¯”å¯¹è¿‡ç¨‹
  
- è¯¥è¿‡ç¨‹çš„è¾“å‡ºç»“æœæ˜¯åç¼€æ•°ç»„/åºåˆ—çš„ç´¢å¼•ï¼ˆSA_indexï¼‰
  
  åç»­ï¼Œä»éœ€è¦éœ€è¦å€ŸåŠ©å…¶ä»–å·¥å…·ç”Ÿæˆ CIGAR ä¸²ç­‰å…¶ä»–çš„æ¯”å¯¹ä¿¡æ¯

---

## å‰æè¯´æ˜

è¯¥åŠ é€Ÿå™¨æ ¸å¿ƒçš„æ‰€å®ç°çš„ç®—æ³•æ¥æºäº**å‚è€ƒæ–‡çŒ®**

è¯¥åŠ é€Ÿå™¨æ ¸å¿ƒçš„æ•´ä½“ç»“æ„ä¸º**çŠ¶æ€æœº**ï¼Œæ¯ä¸ªçŠ¶æ€çš„è®¾è®¡å‚è€ƒäº†**CPUçš„ç»å…¸äº”çº§æµæ°´çº¿**

è®¾è®¡è¯­è¨€ï¼šverilog HDLï¼ˆ2005å¹´æ ‡å‡†ï¼‰

ç›¸å…³å·¥å…·ï¼švivado 2020.1

æ¿è½½éªŒè¯ï¼špynq-z2ï¼ˆé•œåƒv2.6ï¼‰

---

## æƒ³æ³•æ„æ€

  `InexRecur()` æœ¬è´¨ä¸Šæ˜¯é€’å½’è°ƒç”¨ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨ç°åœºå¹¶ä¿å­˜å½“å‰çš„ç»“æœã€‚
  
  æ¯”å¯¹è¿‡ç¨‹éœ€è¦çš„æ•°æ®ï¼š
  
  - 1. ä¸å‚è€ƒåºåˆ—ç›¸å…³ï¼šCï¼ŒOccï¼ˆå‡ºç°æ•°ç»„ï¼‰
  
  - 2. ä¸çŸ­åºåˆ—ç›¸å…³ï¼šWï¼ˆçŸ­åºåˆ—æœ¬èº«ï¼‰ï¼ŒDï¼ˆæœç´¢è¾¹ç•Œï¼‰

  - 3. ä¸æ‰§è¡Œè¿‡ç¨‹æœ‰å…³ï¼šè°ƒç”¨ `InexRecur()` çš„å‚æ•°ï¼Œå½“å‰å‚æ•°æ‰§è¡Œçš„çŠ¶æ€

  å…¶ä¸­ï¼Œå°†1ã€2ä¸¤é¡¹ç§°ä¸º **rom** ï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­åªè¯»ä¸å†™ï¼‰ï¼›3ç§°ä¸º **regfile**ï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰åˆè¯»åˆå†™ï¼‰

  2ã€3é¡¹å’ŒåŠ é€Ÿå™¨æ ¸å¿ƒæ„æˆä¸€ä¸ªå®Œæ•´çš„åŠ é€Ÿå™¨

  ä» rom_Occ ä¸­éœ€è¦è·å–ä¸¤æ¬¡æ•°æ®ï¼Œåˆ†ä¸¤æ¬¡è¯»æ•°æ®ï¼Œå¯¹åº”çŠ¶æ€ **get_data_2** å’Œ **get_data_3**

  ### çŠ¶æ€æœº
  
  ```mermaid
    stateDiagram
        [*] --> idle 
        idle --> get_param : is_start == true
        get_param --> get_data_1 : is_find == true
        get_data_1 --> ex : is_get_data_in_Occ == false
        get_data_1 --> get_data_2 : is_get_data_in_Occ == true
        get_data_2 --> get_data_3
        get_data_3 --> ex
        ex --> write_back
        write_back --> get_param
        ex --> finish : is_finish == true
        finish --> [*]

        state get_param {
          now --> go_back
          go_back --> now
        }

        note right of idle
            å¤ä½åˆå§‹çŠ¶æ€
        end note

        note right of get_param
            åŒ…å«ä¸€ä¸ªå°çš„çŠ¶æ€æœºï¼Œæ‰¾åˆ°å°šæœªå®Œæˆçš„å‚æ•°è°ƒç”¨
        end note
  ```

  ### ç°åœºä¿æŠ¤

  `regfile_state` å’Œ `regfile_InexRecur` ä¸­çš„æ•°æ®ä¸€ä¸€å¯¹åº”ï¼ˆåœ°å€ç›¸åŒï¼‰

  `regfile_InexRecur`: è®°å½•æ¯æ¬¡è°ƒç”¨ `InexRecur()` çš„å‚æ•°

  `regfile_state`ï¼šè®°å½•å¯¹åº”å‚æ•°çš„æ‰§è¡Œä½ç½®ã€è¿”å›åœ°å€ã€å½“å‰æ˜¯å¦æ‰§è¡Œç»“æŸ

  å„ä¸ªæ‰§è¡Œä½ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

  ```
  InexRecur(W, i, z, k, l)
  begin              =================> NONE
  |  if z<D (i) then
  |  |  return Ï†
  |  end             =================> STOP_1
  |  if i < 0 then
  |  |  return [k,l]
  |  end             =================> STOP_2
  |  I = Ï†          
  |  I = I âˆª InexRecur(W, i âˆ’ 1, z âˆ’ 1, k,l)
  |                  =================> INSERTION_{A,C,G,T}
  |  for each b âˆˆ {A, C, G, T} do
  |  |  kb = C (b) + O (b, k âˆ’ 1) + 1
  |  |  lb = C (b) + O (b, l)
  |  |  if kb â‰¤ lb then
  |  |  |  I = I âˆª InexRecur(W, i, z âˆ’ 1, kb, lb)
  |  |  |           =================> DELETION_{A,C,G,T}
  |  |  |  if b = W[i] then
  |  |  |  |  I = I âˆª InexRecur(W, i âˆ’ 1, z, kb, lb)
  |  |  |  |        =================> MATCH_{A,C,G,T}
  |  |  |  else
  |  |  |  |  I = I âˆª  InexRecur(W, i âˆ’ 1, z âˆ’ 1, kb, lb)
  |  |  |  |        =================> SNP_{A,C,G,T}
  |  |  |  end
  |  |  end
  |  end
  |  return I
  end
  ```
---

## æ–‡ä»¶ç»“æ„

`./sim_1` ä¸­ä¸ºæµ‹è¯•æ–‡ä»¶ï¼›`./sources_1` ä¸­ä¸ºæºä»£ç 

ğŸ–æ³¨ï¼š`./sim_1` ä¸­å¾ˆå¤šæµ‹è¯•æ–‡ä»¶æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­å†™çš„ï¼Œå…¶è°ƒç”¨çš„æ¨¡å—åç§°ã€æ¥å£å®šä¹‰ä¸æœ€ç»ˆæˆæœæœ‰å·®å¼‚

`./sim_1` ä¸­çš„æµ‹è¯•æ–‡ä»¶å½¼æ­¤æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œä¸å†å…¶ä»‹ç»æ–‡ä»¶ç»“æ„

`./sources_1/new` ä¸­çš„æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ _top.v                      // æœ€é¡¶å±‚çš„å°è£…
|   |
|   â”œâ”€â”€ _accelerator_top.v      // åŠ é€Ÿå™¨é¡¶å±‚
|   |   |
|   â”‚   â”œâ”€â”€ _accelerator_fsm.v  // åŠ é€Ÿå™¨çŠ¶æ€æ§åˆ¶
|   |   |   |
|   |   |   â”œâ”€â”€ state_control.v  
|   |   |   |
|   |   |   â”œâ”€â”€ get_param.v     // å–å‚æ•°
|   |   |   |
|   |   |   â”œâ”€â”€ get_data_1.v    // å–æ•°æ®(rom_read_and_Dã€rom_C)
|   |   |   |
|   |   |   â”œâ”€â”€ get_data_2.v    // å–æ•°æ®(rom_Occ)
|   |   |   |
|   |   |   â”œâ”€â”€ get_data_3.v    // å–æ•°æ®(rom_Occ)
|   |   |   |
|   |   |   â”œâ”€â”€ exa.v           // åˆ¤æ–­/æ‰§è¡Œ
|   |   |   |
|   |   |   â””â”€â”€ write_back.v    // å›å†™
|   |   |
|   â”‚   â”œâ”€â”€ regfile_InexRecur.v // ä¸¤ä¸ª regfile æ•°æ®å®½åº¦ä¸åŒï¼Œå‡ä¸º regfile.v çš„å®ä¾‹åŒ–
|   |   |  
|   |   â”œâ”€â”€ regfile_state.v     // ä¸¤ä¸ª regfile æ•°æ®å®½åº¦ä¸åŒï¼Œå‡ä¸º regfile.v çš„å®ä¾‹åŒ–
|   |   |
|   |   â””â”€â”€rom_read_and_D.v    
|   |
|   â”œâ”€â”€ rom_Occ.v
|   â””â”€â”€ rom_C.v          
|
â”œâ”€â”€ C.data               // rom_C.v æ•°æ®           C(a)
â”œâ”€â”€ Occ.data             // rom_Occ.v æ•°æ®         Occ(a,i)
â””â”€â”€ read_and_D.data      // rom_read_and_D.v æ•°æ®  Wã€D(i)

```

---

## å¤‡æ³¨ï¼ˆ2020/4/22ï¼‰

ğŸ–æ³¨ï¼šrom ä¸­çš„æ•°æ®åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«åŠ è½½è¿›å»

ğŸ–æ³¨ï¼šå½“å‰å°šæœªè¿›è¡Œæ¿è½½éªŒè¯

æœ‰å…³ python å’Œ C/C++ è¯­è¨€æ‰§è¡Œæ•ˆç‡çš„å·®åˆ«ï¼Œå‚è€ƒ `./reference` ä¸­çš„æ€»ç»“ã€‚

PL éƒ¨åˆ†ä½¿ç”¨ DDR è¯»å–æ•°æ®ã€‚ï¼ˆå¾…å®Œæˆï¼‰

å¤šæ ¸å¿ƒå¤„ç†ã€‚ï¼ˆå¾…å®Œæˆï¼‰
